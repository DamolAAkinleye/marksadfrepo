{
	"name": "datalakeCrud",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "movieupdates_parquet",
						"type": "DatasetReference"
					},
					"name": "dailyChanges",
					"script": "source(output(\n\t\tProp_0 as string,\n\t\tProp_1 as string,\n\t\tProp_2 as string,\n\t\tProp_3 as string,\n\t\tProp_4 as string,\n\t\tProp_5 as string,\n\t\tProp_6 as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false) ~> dailyChanges"
				},
				{
					"dataset": {
						"referenceName": "moviesoutputfolder_parquet",
						"type": "DatasetReference"
					},
					"name": "targetFile",
					"script": "source(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\twildcardPaths:['moviesoutnew.parquet'],\n\tpartitionBy('key',\n\t\t0,\n\t\tMovieId\n\t)) ~> targetFile"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "moviesoutputfolder_parquet",
						"type": "DatasetReference"
					},
					"name": "sinkTargetFile",
					"script": "DedupeUpdates sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tpartitionFileNames:['moviesoutnew.parquet'],\n\tpartitionBy('hash', 1)) ~> sinkTargetFile"
				}
			],
			"transformations": [
				{
					"name": "SetActionUpdate",
					"script": "targetFile derive(Action = 'U') ~> SetActionUpdate"
				},
				{
					"name": "Union1",
					"script": "dailyChanges, SetActionUpdate union(byName: true)~> Union1"
				},
				{
					"name": "DedupeUpdates",
					"script": "RemoveDeletes aggregate(groupBy(MovieIdDupe = MovieId,\n\t\tActionDupe = Action),\n\tMovieId = first(MovieId),\n\t\tTitle = first(Title),\n\t\tGenre = first(Genre),\n\t\tYear = first(Year),\n\t\tRating = first(Rating),\n\t\tRottenTom = first(RottenTom),\n\t\tAction = first(Action)) ~> DedupeUpdates"
				},
				{
					"name": "DeletesOnly",
					"script": "dailyChanges filter(Action == 'D') ~> DeletesOnly"
				},
				{
					"name": "RemoveDeletes",
					"script": "Union1, DeletesOnly exists(Union1@MovieId == dailyChanges@MovieId,\n\tnegate:true,\n\tbroadcast: 'none')~> RemoveDeletes"
				}
			]
		}
	}
}